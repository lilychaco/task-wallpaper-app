<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ã‚¿ã‚¹ã‚¯å£ç´™ãƒ¡ãƒ¼ã‚«ãƒ¼</title>

    <!-- PWAè¨­å®š -->
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#007aff" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="å£ç´™ãƒ¡ãƒ¼ã‚«ãƒ¼" />
    <link rel="apple-touch-icon" href="icon-192.png" />

    <!-- SEOãƒ»OGP -->
    <meta
      name="description"
      content="æ¯æ—¥ã®ã‚¿ã‚¹ã‚¯ã‚’ç¾ã—ã„å£ç´™ã«å¤‰æ›ã™ã‚‹Webã‚¢ãƒ—ãƒª"
    />
    <meta name="keywords" content="å£ç´™,ã‚¿ã‚¹ã‚¯,TODO,ç”Ÿç”£æ€§,ã‚¢ãƒ—ãƒª" />
    <meta property="og:title" content="ã‚¿ã‚¹ã‚¯å£ç´™ãƒ¡ãƒ¼ã‚«ãƒ¼" />
    <meta property="og:description" content="æ¯æ—¥ã®ã‚¿ã‚¹ã‚¯ã‚’ç¾ã—ã„å£ç´™ã«å¤‰æ›" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="icon-512.png" />
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        margin: 0;
        padding: 20px;
        background: #f5f5f7;
        min-height: 100vh;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      h1 {
        text-align: center;
        color: #1d1d1f;
        font-size: 2.5rem;
        margin-bottom: 30px;
      }

      .step {
        background: #f6f6f6;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #007aff;
        overflow: hidden;
      }

      .step h3 {
        margin-top: 0;
        color: #1d1d1f;
      }

      textarea {
        width: 90%;
        height: 200px;
        padding: 15px;
        border: 2px solid #d2d2d7;
        border-radius: 8px;
        font-size: 16px;
        font-family: inherit;
        resize: vertical;
        box-sizing: border-box;
        margin: 0 auto;
        display: block;
      }

      .preview {
        width: 85%;
        max-width: 375px !important;
        height: 812px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        margin: 20px auto;
        border-radius: 25px;
        position: relative;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 80px 10px;
        text-align: center;
        color: white;
        font-size: 16px;
        line-height: 1.8;
        box-sizing: border-box;
        word-wrap: break-word;
        overflow-wrap: break-word;
        overflow: hidden;
      }

      .preview-date {
        position: absolute;
        top: 80px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 14px;
        opacity: 0.9;
        width: 300px;
        text-align: center;
      }

      .preview-title {
        font-size: 26px;
        font-weight: bold;
        margin-bottom: 30px;
        max-width: 280px;
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
      }

      .preview-tasks {
        font-size: 16px;
        margin-bottom: 30px;
        max-width: 280px;
        word-wrap: break-word;
        overflow-wrap: break-word;
        text-align: left;
      }

      .preview-motto {
        position: absolute;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 14px;
        font-style: italic;
        opacity: 0.8;
        max-width: 280px;
        text-align: center;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }

      .buttons {
        text-align: center;
        margin-top: 30px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        align-items: center;
      }

      button {
        background: #007aff;
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 250px;
        max-width: 90%;
      }

      button:hover {
        background: #0056cc;
        transform: translateY(-2px);
      }

      .instruction {
        background: #e8f5e8;
        border: 1px solid #34c759;
        border-radius: 8px;
        padding: 20px;
        margin-top: 30px;
      }

      .instruction h3 {
        color: #30a46c;
        margin-top: 0;
      }

      .bg-selector {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin: 20px 0;
      }

      .bg-option {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        cursor: pointer;
        border: 3px solid transparent;
        transition: all 0.3s ease;
      }

      .bg-option:hover {
        transform: scale(1.1);
      }

      .bg-option.active {
        border-color: #007aff;
        transform: scale(1.1);
      }

      .bg1 {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      .bg2 {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      }
      .bg3 {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      }
      .bg4 {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      }
      .bg5 {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      }

      /* ã‚¹ãƒãƒ›å¯¾å¿œã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–èª¿æ•´ */
      @media (max-width: 768px) {
        .container {
          margin: 10px;
          padding: 10px;
        }

        textarea {
          font-size: 14px;
        }

        .preview {
          width: 100%;
          max-width: 375px;
          height: 600px !important;
          margin: 15px auto;
          padding: 60px 0px;
        }



        button {
          width: 100%;
          max-width: none;
          font-size: 14px;
          padding: 12px 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ“± ã‚·ãƒ³ãƒ—ãƒ«å£ç´™ãƒ¡ãƒ¼ã‚«ãƒ¼</h1>

      <div class="step">
        <h3>ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ¡ãƒ¢å¸³ã®å†…å®¹ã‚’è²¼ã‚Šä»˜ã‘</h3>
        <textarea
          id="taskInput"
          placeholder="ãƒ¡ãƒ¢å¸³ã®å†…å®¹ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„..."
        ></textarea>
      </div>

      <div class="step">
        <h3>ã‚¹ãƒ†ãƒƒãƒ—2: èƒŒæ™¯è‰²ã‚’é¸æŠ</h3>
        <div class="bg-selector">
          <div class="bg-option bg1 active" data-bg="bg1"></div>
          <div class="bg-option bg2" data-bg="bg2"></div>
          <div class="bg-option bg3" data-bg="bg3"></div>
          <div class="bg-option bg4" data-bg="bg4"></div>
          <div class="bg-option bg5" data-bg="bg5"></div>
        </div>
      </div>

      <div class="step">
        <h3>ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç¢ºèª</h3>
        <div class="preview bg1" id="preview">
          <div class="preview-date" id="previewDate"></div>
          <div class="preview-title" id="previewTitle">ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯å®£è¨€</div>
          <div class="preview-tasks" id="previewTasks">
            ã‚¿ã‚¹ã‚¯ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
          </div>
          <div class="preview-motto" id="previewMotto">ç¶™ç¶šã¯åŠ›ãªã‚Š</div>
        </div>
      </div>

      <div class="buttons">
        <button onclick="updatePreview()">ğŸ”„ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°</button>
        <button id="downloadBtn">ğŸ“± å£ç´™ã‚’è¡¨ç¤º</button>
      </div>

      <div class="instruction">
        <h3>ğŸ¯ ä½¿ã„æ–¹ï¼ˆè¶…ç°¡å˜ï¼‰</h3>
        <ol>
          <li><strong>ãƒ¡ãƒ¢å¸³ã§Cmd+A â†’ Cmd+C</strong> (å…¨é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼)</li>
          <li><strong>ä¸Šã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã§Cmd+V</strong> (è²¼ã‚Šä»˜ã‘)</li>
          <li><strong>å¥½ããªèƒŒæ™¯è‰²ã‚’ã‚¯ãƒªãƒƒã‚¯</strong></li>
          <li><strong>ã€ŒğŸ”„ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°ã€ã‚’ã‚¯ãƒªãƒƒã‚¯</strong></li>
          <li><strong>ã€ŒğŸ“± å£ç´™ã‚’è¡¨ç¤ºã€ã‚’ã‚¯ãƒªãƒƒã‚¯</strong></li>
          <li><strong>è¡¨ç¤ºã•ã‚ŒãŸç”»åƒã‚’é•·æŠ¼ã— â†’ ã€Œå†™çœŸã«ä¿å­˜ã€</strong></li>
        </ol>

        <div
          style="
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
          "
        >
          <h4 style="margin-top: 0; color: #856404">ğŸ“± ãƒ–ãƒ©ã‚¦ã‚¶åˆ¥ã®æ³¨æ„ç‚¹</h4>
          <p style="margin: 5px 0; color: #856404">
            <strong>Safariæ¨å¥¨:</strong> æ­£å¸¸ã«ç”»åƒãŒè¡¨ç¤ºã•ã‚Œã¾ã™
          </p>
          <p style="margin: 5px 0; color: #856404">
            <strong>Chrome:</strong> ç™½ã„ç”»é¢ãŒé–‹ãå ´åˆã¯Safariã‚’ãŠè©¦ã—ãã ã•ã„
          </p>
        </div>
      </div>
    </div>

    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script>
      // æ—¥ä»˜æ›´æ–°
      function updateDate() {
        const now = new Date();
        const dateStr = now.toLocaleDateString("ja-JP", {
          year: "numeric",
          month: "long",
          day: "numeric",
          weekday: "long",
        });
        document.getElementById("previewDate").textContent = dateStr;
      }

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
      function updatePreview() {
        const text = document.getElementById("taskInput").value;
        const lines = text.split("\n").filter((line) => line.trim() !== "");

        let title = "";
        let tasks = [];
        let motto = "";

        // ç°¡å˜ãªè§£æ
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i].trim();

          if (line.includes("ã‚¿ã‚¹ã‚¯å®£è¨€") || line.includes("ç›®æ¨™")) {
            title = line;
          } else if (
            line.includes("-") ||
            line.includes("ãƒ»") ||
            line.includes("â—‹")
          ) {
            tasks.push(line.replace(/^[-ãƒ»â—‹]\s*/, ""));
          } else if (
            i === lines.length - 1 ||
            line.includes("ç¶™ç¶š") ||
            line.includes("é ‘å¼µ") ||
            line.includes("ã‚ˆã‚ã—ã")
          ) {
            motto = line;
          }
        }

        document.getElementById("previewTitle").textContent =
          title || "ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯å®£è¨€";
        document.getElementById("previewTasks").innerHTML =
          tasks.slice(0, 6).join("<br>") || "ã‚¿ã‚¹ã‚¯ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
        document.getElementById("previewMotto").textContent =
          motto || "é ‘å¼µã‚Šã¾ã—ã‚‡ã†";
      }

      // èƒŒæ™¯å¤‰æ›´
      function changeBackground(bgClass) {
        const preview = document.getElementById("preview");
        preview.className = `preview ${bgClass}`;
      }

      // å£ç´™ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      function downloadWallpaper() {
        generateWallpaper();
      }

      async function generateWallpaper() {
        const preview = document.getElementById("preview");

        try {

          // ä¸€æ™‚çš„ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’375pxå¹…ã«ã—ã¦ç”»åƒç”Ÿæˆ
          const originalStyle = preview.getAttribute('style') || '';
          preview.style.width = '375px';
          preview.style.maxWidth = '375px';
          preview.style.minWidth = '375px';

          // å°‘ã—å¾…ã£ã¦ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å®‰å®šã•ã›ã‚‹
          await new Promise(resolve => setTimeout(resolve, 200));

          // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãã§html2canvaså®Ÿè¡Œ
          const canvas = await Promise.race([
            html2canvas(preview, {
              width: 375,
              height: 812,
              scale: 1,
              backgroundColor: null,
              logging: false,
              useCORS: false,
              allowTaint: false,
              foreignObjectRendering: false,
              imageTimeout: 15000,
              removeContainer: false
            }),
            new Promise((_, reject) =>
              setTimeout(() => reject(new Error('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ')), 10000)
            )
          ]);

          // å…ƒã®ã‚¹ã‚¿ã‚¤ãƒ«ã«æˆ»ã™
          if (originalStyle) {
            preview.setAttribute('style', originalStyle);
          } else {
            preview.removeAttribute('style');
          }

          const dataURL = canvas.toDataURL("image/png", 1.0);

          // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’ãƒã‚§ãƒƒã‚¯
          if (dataURL.length < 1000) {
            alert(
              "âŒ ç”»åƒç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°ã—ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚"
            );
            return;
          }


          // ç”»åƒè¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’ä½œæˆ
          showSaveableImage(dataURL);
        } catch (error) {
          console.error("ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:", error);
          alert(
            "âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + error.message
          );
        }
      }

      // ä¿å­˜å¯èƒ½ãªç”»åƒã‚’è¡¨ç¤º
      function showSaveableImage(dataURL) {
        // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒã‚ã‚Œã°å‰Šé™¤
        const existingModal = document.getElementById("saveModal");
        if (existingModal) {
          document.body.removeChild(existingModal);
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ä½œæˆ
        const modal = document.createElement("div");
        modal.id = "saveModal";
        modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.95);
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                padding: 20px;
                box-sizing: border-box;
            `;

        // ç”»åƒè¦ç´ 
        const img = document.createElement("img");
        img.src = dataURL;
        img.alt = "å£ç´™ç”»åƒ";
        img.style.cssText = `
                max-width: 90%;
                max-height: 60%;
                border-radius: 15px;
                box-shadow: 0 8px 40px rgba(0,0,0,0.6);
                user-select: none;
                -webkit-user-select: none;
                -webkit-touch-callout: default;
            `;

        // èª¬æ˜ãƒ†ã‚­ã‚¹ãƒˆ
        const instruction = document.createElement("div");
        instruction.style.cssText = `
                color: white;
                text-align: center;
                margin-top: 30px;
                padding: 20px;
                background: rgba(255,255,255,0.1);
                border-radius: 15px;
                font-size: 18px;
                line-height: 1.6;
                max-width: 350px;
            `;
        instruction.innerHTML = `
                <h3 style="margin-top: 0; color: #fff; font-size: 20px;">ğŸ“± ä¿å­˜æ–¹æ³•</h3>
                <p style="margin: 10px 0;">ç”»åƒã‚’<strong>é•·æŠ¼ã—</strong>ã—ã¦ãã ã•ã„</p>
                <p style="margin: 10px 0;">ã€Œç”»åƒã‚’ä¿å­˜ã€ã¾ãŸã¯<br>ã€Œå†™çœŸã«ä¿å­˜ã€ã‚’é¸æŠ</p>
                <p style="margin: 10px 0; font-size: 14px; opacity: 0.8;">ä¿å­˜å¾Œã¯è¨­å®šâ†’å£ç´™ã‹ã‚‰é¸æŠã§ãã¾ã™</p>
            `;

        // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
        const closeBtn = document.createElement("button");
        closeBtn.textContent = "âœ• é–‰ã˜ã‚‹";
        closeBtn.style.cssText = `
                position: absolute;
                top: 30px;
                right: 30px;
                background: rgba(255,255,255,0.2);
                color: white;
                border: none;
                padding: 12px 20px;
                border-radius: 25px;
                font-size: 16px;
                cursor: pointer;
                backdrop-filter: blur(10px);
                z-index: 10001;
            `;

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        closeBtn.onclick = () => {
          document.body.removeChild(modal);
        };

        modal.onclick = (e) => {
          if (e.target === modal) {
            document.body.removeChild(modal);
          }
        };

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«è¦ç´ ã‚’è¿½åŠ 
        modal.appendChild(closeBtn);
        modal.appendChild(img);
        modal.appendChild(instruction);

        // bodyã«è¿½åŠ 
        document.body.appendChild(modal);

        // å°‘ã—é…ã‚Œã¦ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
        setTimeout(() => {
          alert(
            "âœ… ç”»åƒã‚’è¡¨ç¤ºã—ã¾ã—ãŸï¼\n\nç”»åƒã‚’é•·æŠ¼ã—ã—ã¦ã€Œç”»åƒã‚’ä¿å­˜ã€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"
          );
        }, 300);
      }

      // PWA Service Workerç™»éŒ²
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", function () {
          navigator.serviceWorker
            .register("./sw.js")
            .then(function (registration) {
              console.log("SW registered: ", registration);
            })
            .catch(function (registrationError) {
              console.log("SW registration failed: ", registrationError);
            });
        });
      }

      // PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
      let deferredPrompt;
      window.addEventListener("beforeinstallprompt", (e) => {
        e.preventDefault();
        deferredPrompt = e;
        showInstallPromotion();
      });

      function showInstallPromotion() {
        const installBanner = document.createElement("div");
        installBanner.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: #007aff;
                color: white;
                padding: 15px;
                text-align: center;
                z-index: 9999;
                font-size: 14px;
            `;
        installBanner.innerHTML = `
                ğŸ“± ã‚¢ãƒ—ãƒªã¨ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã™ï¼
                <button onclick="installPWA()" style="margin-left: 10px; padding: 5px 15px; background: white; color: #007aff; border: none; border-radius: 5px; cursor: pointer;">
                    ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
                </button>
                <button onclick="this.parentElement.remove()" style="margin-left: 5px; padding: 5px 10px; background: transparent; color: white; border: 1px solid white; border-radius: 5px; cursor: pointer;">
                    Ã—
                </button>
            `;
        document.body.insertBefore(installBanner, document.body.firstChild);
      }

      window.installPWA = async function () {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          console.log(`User response to the install prompt: ${outcome}`);
          deferredPrompt = null;
        }
      };

      // åˆæœŸåŒ–
      document.addEventListener("DOMContentLoaded", function () {
        updateDate();
        updatePreview();

        // èƒŒæ™¯é¸æŠ
        document.querySelectorAll(".bg-option").forEach((option) => {
          option.addEventListener("click", function () {
            document
              .querySelectorAll(".bg-option")
              .forEach((opt) => opt.classList.remove("active"));
            this.classList.add("active");
            changeBackground(this.dataset.bg);
          });
        });

        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
        document
          .getElementById("taskInput")
          .addEventListener("input", updatePreview);

        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
        document
          .getElementById("downloadBtn")
          .addEventListener("click", function (e) {
            e.preventDefault();
            e.stopPropagation();
            downloadWallpaper();
          });
      });
    </script>
  </body>
</html>
